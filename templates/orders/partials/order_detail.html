{% load djicons i18n djicons djicons %}

<!-- Back + Header -->
<div class="p-4">
    <button type="button"
            hx-get="{% url 'orders:active_orders' %}"
            hx-target="#main-content-area"
            hx-push-url="true"
            class="btn btn-ghost mb-3">
        {% icon "arrow-back-outline" %}
        {% trans "Back to Orders" %}
    </button>

    <div class="card mb-4">
        <div class="card-header">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="card-title">{% trans "Order" %} #{{ order.order_number }}</h2>
                    <p class="text-sm opacity-60">
                        {% if order.table %}{% trans "Table" %} {{ order.table_display }} &middot; {% endif %}
                        {{ order.get_order_type_display }}
                        {% if order.waiter %} &middot; {{ order.waiter.name }}{% endif %}
                    </p>
                </div>
                <span class="badge badge-lg color-{% if order.status == 'pending' %}warning{% elif order.status == 'preparing' %}primary{% elif order.status == 'ready' %}success{% elif order.status == 'served' %}medium{% elif order.status == 'paid' %}success{% elif order.status == 'cancelled' %}error{% else %}medium{% endif %}" id="order-status-badge">
                    {{ order.get_status_display }}
                </span>
            </div>
        </div>
        <div class="card-body">
            <!-- Stats row -->
            <div class="grid grid-cols-3 gap-4 mb-4">
                <div class="text-center">
                    <div class="text-2xl font-bold">{{ order.item_count }}</div>
                    <div class="text-xs text-muted">{% trans "Items" %}</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold">{{ order.elapsed_minutes }}{% trans "min" %}</div>
                    <div class="text-xs text-muted">{% trans "Elapsed" %}</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold">R{{ order.round_number }}</div>
                    <div class="text-xs text-muted">{% trans "Round" %}</div>
                </div>
            </div>

            {% if order.priority == 'rush' or order.priority == 'high' %}
            <div class="badge color-{% if order.priority == 'rush' %}error{% else %}warning{% endif %} mb-3">
                {% icon "flash-outline" %} {{ order.get_priority_display }}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Workflow Actions -->
    {% if order.status != 'paid' and order.status != 'cancelled' %}
    <div class="flex flex-wrap gap-2 mb-4" id="order-actions">
        {% if order.status == 'pending' %}
        <button type="button" class="btn color-primary flex-1"
                onclick="orderAction('{% url 'orders:fire' order.id %}', 'fire')">
            {% icon "flame-outline" %} {% trans "Fire Order" %}
        </button>
        {% endif %}

        {% if order.status == 'preparing' %}
        <button type="button" class="btn color-success flex-1"
                onclick="orderAction('{% url 'orders:bump' order.id %}', 'bump')">
            {% icon "checkmark-done-outline" %} {% trans "Bump Ready" %}
        </button>
        {% endif %}

        {% if order.status == 'ready' %}
        <button type="button" class="btn color-success flex-1"
                onclick="orderAction('{% url 'orders:serve' order.id %}', 'serve')">
            {% icon "restaurant-outline" %} {% trans "Mark Served" %}
        </button>
        <button type="button" class="btn color-warning flex-1"
                onclick="orderAction('{% url 'orders:recall' order.id %}', 'recall')">
            {% icon "arrow-undo-outline" %} {% trans "Recall" %}
        </button>
        {% endif %}

        <a hx-get="{% url 'orders:add_item' order.id %}"
           hx-target="#main-content-area"
           hx-push-url="true"
           class="btn btn-outline flex-1">
            {% icon "add-outline" %} {% trans "Add Item" %}
        </a>

        <a hx-get="{% url 'orders:edit' order.id %}"
           hx-target="#main-content-area"
           hx-push-url="true"
           class="btn btn-outline">
            {% icon "create-outline" %}
        </a>

        <button type="button" class="btn btn-outline color-error"
                onclick="cancelOrder()">
            {% icon "close-outline" %}
        </button>
    </div>
    {% endif %}

    <!-- Order Info -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="card-title">{% trans "Details" %}</h3>
        </div>
        <div class="list">
            {% if order.customer %}
            <div class="list-item">
                <div class="list-item-start">{% icon "person-outline" css_class="text-muted" %}</div>
                <div class="list-item-content">
                    <div class="list-item-label">{{ order.customer.name }}</div>
                    <div class="list-item-note">{% trans "Customer" %}</div>
                </div>
            </div>
            {% endif %}
            {% if order.waiter %}
            <div class="list-item">
                <div class="list-item-start">{% icon "people-outline" css_class="text-muted" %}</div>
                <div class="list-item-content">
                    <div class="list-item-label">{{ order.waiter.name }}</div>
                    <div class="list-item-note">{% trans "Waiter" %}</div>
                </div>
            </div>
            {% endif %}
            <div class="list-item">
                <div class="list-item-start">{% icon "time-outline" css_class="text-muted" %}</div>
                <div class="list-item-content">
                    <div class="list-item-label">{{ order.created_at|date:"d/m/Y H:i" }}</div>
                    <div class="list-item-note">{% trans "Created" %}</div>
                </div>
            </div>
            {% if order.notes %}
            <div class="list-item">
                <div class="list-item-start">{% icon "document-text-outline" css_class="text-muted" %}</div>
                <div class="list-item-content">
                    <div class="list-item-label">{{ order.notes }}</div>
                    <div class="list-item-note">{% trans "Notes" %}</div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Items -->
    <div class="card mb-4">
        <div class="card-header">
            <div class="flex items-center justify-between">
                <h3 class="card-title">{% trans "Items" %}</h3>
                <span class="badge">{{ items|length }}</span>
            </div>
        </div>
        <div class="list">
            {% for item in items %}
            <div class="list-item">
                <div class="list-item-start">
                    <span class="font-semibold">{{ item.quantity }}x</span>
                </div>
                <div class="list-item-content">
                    <div class="list-item-label">{{ item.product_name }}</div>
                    <div class="list-item-note">
                        {% if item.station %}{% icon "navigate-outline" css_class="text-xs" %} {{ item.station.name }}{% endif %}
                        {% if item.modifiers %} &middot; {{ item.modifiers }}{% endif %}
                        {% if item.notes %} &middot; <em>{{ item.notes }}</em>{% endif %}
                        {% if item.seat_number %} &middot; {% trans "Seat" %} {{ item.seat_number }}{% endif %}
                    </div>
                </div>
                <div class="list-item-end text-right">
                    <div class="font-semibold">{{ item.total }}</div>
                    <span class="badge badge-sm color-{% if item.status == 'ready' %}success{% elif item.status == 'cancelled' %}error{% elif item.status == 'preparing' %}primary{% else %}warning{% endif %}">
                        {{ item.get_status_display }}
                    </span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Financial Summary -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">{% trans "Summary" %}</h3>
        </div>
        <div class="list">
            <div class="list-item">
                <div class="list-item-content">
                    <div class="list-item-label">{% trans "Subtotal" %}</div>
                </div>
                <div class="list-item-end font-semibold">{{ order.subtotal }}</div>
            </div>
            {% if order.discount_amount %}
            <div class="list-item">
                <div class="list-item-content">
                    <div class="list-item-label text-success">{% trans "Discount" %}</div>
                </div>
                <div class="list-item-end font-semibold text-success">-{{ order.discount_amount }}</div>
            </div>
            {% endif %}
            {% if order.tax_amount %}
            <div class="list-item">
                <div class="list-item-content">
                    <div class="list-item-label">{% trans "Tax" %}</div>
                </div>
                <div class="list-item-end font-semibold">{{ order.tax_amount }}</div>
            </div>
            {% endif %}
            <div class="list-item" style="border-top: 2px solid var(--color-base-300)">
                <div class="list-item-content">
                    <div class="list-item-label font-bold text-lg">{% trans "Total" %}</div>
                </div>
                <div class="list-item-end font-bold text-lg">{{ order.total }}</div>
            </div>
        </div>
    </div>

    <!-- Danger Zone (delete) -->
    {% if order.status == 'pending' %}
    <div class="card mt-4" style="border-color: var(--color-error)">
        <div class="card-header">
            <h3 class="card-title text-error">{% trans "Danger Zone" %}</h3>
        </div>
        <div class="card-body">
            <p class="text-muted mb-3">{% trans "Permanently delete this order. This action cannot be undone." %}</p>
            <button type="button" class="btn btn-outline color-error"
                    onclick="deleteOrder()">
                {% icon "trash-outline" %} {% trans "Delete Order" %}
            </button>
        </div>
    </div>
    {% endif %}
</div>

<script>
function orderAction(url, action) {
    fetch(url, {
        method: 'POST',
        headers: {'X-CSRFToken': '{{ csrf_token }}'},
    }).then(r => r.json()).then(data => {
        if (data.success) {
            htmx.ajax('GET', '{% url "orders:detail" order.id %}', '#main-content-area');
        }
    });
}

function cancelOrder() {
    if (confirm('{% trans "Cancel this order?" %}')) {
        const reason = prompt('{% trans "Reason (optional):" %}') || '';
        fetch('{% url "orders:cancel" order.id %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'reason=' + encodeURIComponent(reason),
        }).then(r => r.json()).then(data => {
            if (data.success) {
                htmx.ajax('GET', '{% url "orders:active_orders" %}', '#main-content-area');
            }
        });
    }
}

function deleteOrder() {
    if (confirm('{% trans "Delete this order permanently?" %}')) {
        fetch('{% url "orders:delete" order.id %}', {
            method: 'POST',
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
        }).then(r => r.json()).then(data => {
            if (data.success) {
                htmx.ajax('GET', '{% url "orders:active_orders" %}', '#main-content-area');
            }
        });
    }
}
</script>
